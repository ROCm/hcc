#!/usr/bin/env groovy

import java.text.SimpleDateFormat

//===----------------------------------------------------------------------===//
// Helpers.                                                                   //
//===----------------------------------------------------------------------===//

def autoclean_node(name, commands) {
  node (name) {
    def workspace = pwd()
    try {
      deleteDir()
      commands()
    } finally {
      dir (workspace) {
        deleteDir()
      }
    }
  }
}

def git_config() {
  def git_email = "dsalinas@amd.com" // "jenkins-compute@amd.com"
  def git_name = "David Salinas" // Jenkins Compute"

  sh (script:"git config user.email ${git_email}")
  sh (script:"git config user.name ${git_name}")
}


//def git_remote_exists(workspace, remote_name) {

//	dir(workspace) {
//		sh "git remote -v | grep ${remote_name}"
//		def retstat = sh(script: 'git remote -v | grep ${remote_name}', returnStatus: true)
//	}
//}

 def git_remote_add(workspace, remote_name, remote_url) {
	sh (script:"cd ${ workspace}; git remote add ${remote_name} ${remote_url}")
 }
 
 def send_email(status) {
  emailext (
    to: 'dsalinas@amd.com',
    subject: "${status}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
    body: "${status}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'; see console output at ${env.BUILD_URL}"
  )
}

node ('rocmtest') 
{
 stage('HCC Checkout')
  {
    checkout([
      $class: 'GitSCM',
      branches: scm.branches,
      doGenerateSubmoduleConfigurations: scm.doGenerateSubmoduleConfigurations,
      extensions: scm.extensions + [[$class: 'CleanCheckout'], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: false, recursiveSubmodules: true, reference: '', timeout: 60, trackingSubmodules: false]],
      userRemoteConfigs: scm.userRemoteConfigs
    ])
  }
  
  def hcc_build_image = null
  stage('ubuntu-16.04 image')
  {
    def user_uid = sh( script: 'id -u', returnStdout: true ).trim()
    def build_org = "david-salinas"
    def build_type_name = "upstream-merge-ubuntu-16.04"
    def dockerfile_name = "dockerfile-${build_type_name}"
    def build_image_name = "${build_type_name}"
    dir('docker')
    {
       hcc_build_image = docker.build( "${build_org}/${build_image_name}:latest", "-f ${dockerfile_name} --build-arg build_type=Release --build-arg user_uid=${user_uid} --build-arg rocm_install_path=/opt/rocm ." )
    }
  }
 
// JENKINS-33510: the jenkinsfile dir() command is not workin well with docker.inside()
  hcc_build_image.inside( '--device=/dev/kfd' )
  {
  try { 
	//	stage ('Clone HCC with repo') 
	//	{ 
	//	    deleteDir()
	//		sh (script: "repo init -u https://github.com/RadeonOpenCompute/HCC-Native-GCN-ISA.git")
	//		sh (script: "repo sync")
	//	}
		
		stage('Clone HCC repo manifest') { 
			if (!fileExists("manifest")) {
			  sh (script:"git clone https://github.com/RadeonOpenCompute/HCC-Native-GCN-ISA.git manifest")
			}
		}
		
		stage('Initialize GIT submodules') { 
			if (!fileExists("hcc_fork")) {
				sh (script:"git clone https://github.com/david-salinas/hcc.git hcc_fork")  
				sh (script: "cd hcc_fork; git checkout clang_tot_upgrade; git submodule update --init")
			}
		}
		
//		stage ('Add all remotes and forks for submodules') {
//			git_remote_add("hcc_fork","hcc_fork", "https://github.com/david-salinas/hcc.git");
//			git_remote_add("hcc_fork/lld","lld_fork", "https://github.com/david-salinas/lld.git");
//			git_remote_add("hcc_fork/compiler","llvm_fork", "https://github.com/david-salinas/llvm.git");
//			git_remote_add("hcc_fork/compiler-rt","compiler-rt_fork", "https://github.com/david-salinas/compiler-rt.git");
//			git_remote_add("hcc_fork/compiler-rt","compiler-rt", "https://github.com/llvm-mirror/compiler-rt.git");
//			git_remote_add("hcc_fork/clang-tools-extra","clang-tools-extra_fork", "https://github.com/david-salinas/clang-tools-extra.git");
//			git_remote_add("hcc_fork/clang-tools-extra","clang-tools-extra", "https://github.com/llvm-mirror/clang-tools-extra.git");
//			git_remote_add("hcc_fork/clang","clang_fork", "https://github.com/david-salinas/hcc_clang_upgrade.git");
//			git_remote_add("hcc_fork/clang","clang", "https://github.com/RadeonOpenCompute/clang.git");			
//		}
		
		stage ('Checkout latest master ROCM-Device-Libs') {
			sh (script: "cd hcc_fork/rocdl; git fetch --all; git checkout origin/master")
		}
		
		
		stage ('Merge amd-common LLD commits') {
			def dateFormat = new SimpleDateFormat("yyyyMMddHHmm")
			def date = new Date()
			String merge_name = "auto_merge_" + dateFormat.format(date)
			sh (script: "cd hcc_fork/lld; git fetch --all ; git checkout -b ${merge_name} origin/amd-hcc; git merge origin/amd-common --no-edit")
		}
		
	} catch(e) {
	   send_email("FAILED")
	  throw e
	}
  }
}
